{{#section "styles"}}
<link rel="stylesheet" href="/css/panel_pacjent.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
{{/section}}
{{#section "scripts"}}
<script src="/js/panel_pacjent.js"></script>
{{/section}}
<div id="panel-pacjent" class="container-fluid py-5" style="max-width: 1600px;">
    <h2 class="mb-4 text-center fw-bold">Panel pacjenta</h2>
    <!-- NAWIGACJA Z IKONAMI -->
    <div class="d-flex justify-content-center gap-3 mb-4 panel-nav flex-wrap">
        <button class="btn btn-outline-primary active d-flex align-items-center gap-2" id="btn-dashboard">
            <i class="bi bi-speedometer2"></i>
            <span class="d-inline">Dashboard</span>
        </button>
        <button class="btn btn-outline-primary d-flex align-items-center gap-2" id="btn-edit-profile">
            <i class="bi bi-person-circle"></i>
            <span class="d-inline">Edytuj profil</span>
        </button>
        <button class="btn btn-outline-primary d-flex align-items-center gap-2" id="btn-visit">
            <i class="bi bi-calendar-plus"></i>
            <span class="d-inline">Umów wizytę</span>
        </button>
        <button class="btn btn-outline-primary d-flex align-items-center gap-2" id="btn-opinie">
            <i class="bi bi-star"></i>
            <span class="d-inline">Opinie</span>
        </button>
        <button class="btn btn-outline-primary d-flex align-items-center gap-2" id="btn-contact">
            <i class="bi bi-envelope"></i>
            <span class="d-inline">Kontakt</span>
        </button>
        <button class="btn btn-outline-primary d-flex align-items-center gap-2" id="btn-chats">
            <i class="bi bi-chat-dots"></i>
            <span class="d-inline">Rozmowy</span>
        </button>
    </div>
    <div class="card shadow-sm p-4">
        <!-- DASHBOARD -->
        <div id="section-dashboard">
            <h4 class="fw-semibold mb-4">Witaj, {{user.imie}} {{user.nazwisko}}!</h4>
            <div class="row g-4 mb-4">
                <div class="col-md-3">
                    <div class="card stat-card h-100 text-center border-primary">
                        <div class="card-body">
                            <h5 class="card-title text-primary fw-bold">Najbliższe wizyty</h5>
                            <p id="stat-wizyty" class="fs-3 fw-bold mb-1">—</p>
                            <small class="text-muted">Kliknij, aby zobaczyć szczegóły</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card h-100 text-center border-info">
                        <div class="card-body">
                            <h5 class="card-title text-info fw-bold">Odbyte wizyty</h5>
                            <p id="stat-odbyte" class="fs-3 fw-bold mb-1">—</p>
                            <small class="text-muted">Historia zakończonych wizyt</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card h-100 text-center border-success">
                        <div class="card-body">
                            <h5 class="card-title text-success fw-bold">Recepty</h5>
                            <p id="stat-recepty" class="fs-3 fw-bold mb-1">—</p>
                            <small class="text-muted">Zobacz wystawione recepty</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card h-100 text-center border-warning">
                        <div class="card-body">
                            <h5 class="card-title text-warning fw-bold">Powiadomienia</h5>
                            <p id="stat-powiadomienia" class="fs-3 fw-bold mb-1">—</p>
                            <small class="text-muted">Nowe wiadomości od kliniki</small>
                        </div>
                    </div>
                </div>
            </div>
            <div id="search-container" class="d-none mb-3">
                <div class="input-group">
                    <input type="text" id="search-input" class="form-control"
                        placeholder="Szukaj we wszystkich polach...">
                    <button id="btn-show-all" class="btn btn-outline-secondary">Pokaż wszystkie</button>
                </div>
            </div>
            <div id="dashboard-details"></div>
            <div id="pagination-container" class="d-none mt-3 text-center"></div>
        </div>
        <!-- EDYTUJ PROFIL -->
        <div id="section-edit" class="d-none">
            <h4 class="fw-semibold mb-4 text-center">Edytuj profil</h4>
            <div class="text-center mb-4">
                <img id="current-avatar"
                    src="/images/avatar/{{#if user.avatar}}{{user.avatar}}{{else}}default-avatar.png{{/if}}"
                    class="rounded-circle border" width="120" height="120"
                    style="object-fit: cover; box-shadow: 0 0 8px rgba(0,0,0,0.2);" alt="Avatar pacjenta">
                <p class="mt-2 mb-0 fw-semibold">{{user.imie}} {{user.nazwisko}}</p>
            </div>
            <form id="edit-profile-form" class="border rounded p-4 bg-light" enctype="multipart/form-data">
                <p class="text-muted mb-4">Wpisz tylko te dane, które chcesz zmienić. Puste pola pozostaną bez zmian.
                </p>
                <div class="mb-3">
                    <label class="form-label fw-semibold">Zdjęcie profilowe</label>
                    <input type="file" name="avatar" class="form-control" accept="image/png,image/jpeg,image/webp" />
                    <small class="text-muted">Maks. 2MB, PNG/JPG/WEBP. Zostaw puste, jeśli nie chcesz zmieniać.</small>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">E-mail</label>
                        <input type="email" name="email" class="form-control" placeholder="Edytuj e-mail" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Numer telefonu</label>
                        <input type="tel" name="telefon" class="form-control"
                            placeholder="Edytuj numer telefonu (9 cyfr)" maxlength="9" pattern="[0-9]{9}"
                            inputmode="numeric" oninput="this.value = this.value.replace(/\D/g, '').slice(0,9)" />
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">PESEL</label>
                        <input type="text" name="pesel" class="form-control" placeholder="Edytuj PESEL (11 cyfr)"
                            maxlength="11" inputmode="numeric" id="input-pesel"
                            oninput="this.value = this.value.replace(/\D/g, '').slice(0,11)" />
                    </div>
                </div>
                <hr class="my-4" />
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Stare hasło</label>
                        <input type="password" name="oldPassword" class="form-control"
                            placeholder="Podaj stare hasło" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Nowe hasło</label>
                        <input type="password" name="newPassword" class="form-control"
                            placeholder="Nowe hasło (opcjonalnie)" />
                    </div>
                </div>
                <button type="submit" class="btn btn-primary mt-2">Zapisz zmiany</button>
            </form>
            <div id="edit-profile-message" class="mt-3"></div>
        </div>
        <!-- UMÓW WIZYTĘ -->
        <div id="section-visit" class="d-none">
            <h4 class="fw-semibold mb-4">Umów wizytę</h4>
            <form id="form-visit" class="border rounded p-4 bg-light">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Specjalizacja</label>
                        <select id="select-specialization" class="form-select" required>
                            <option value="">Wybierz specjalizację...</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Lekarz</label>
                        <select id="select-doctor" class="form-select" required disabled>
                            <option value="">Najpierw wybierz specjalizację</option>
                        </select>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-semibold">Data wizyty</label>
                    <input type="datetime-local" id="visit-date" class="form-control" required />
                </div>
                <div class="mb-3">
                    <label class="form-label fw-semibold">Notatka dla lekarza (opcjonalna)</label>
                    <textarea id="visit-note" class="form-control" rows="2"
                        placeholder="Np. objawy lub powód wizyty..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Zarezerwuj termin</button>
            </form>
            <div id="visit-message" class="mt-3"></div>
        </div>
        <!-- OPINIE -->
        <div id="section-opinie" class="d-none animate-section">
            <h4 class="fw-semibold mb-4">Twoje opinie</h4>

            <!-- formularz z takim samym tłem jak "Umów wizytę" -->
            <form id="form-opinia" class="border rounded p-4 bg-light mb-4">
                <div class="mb-3">
                    <label class="form-label fw-semibold">Oceń klinikę</label>
                    <div class="d-flex gap-2">
                        <input type="radio" name="ocena" value="5" id="ocena-5" class="btn-check" required>
                        <label class="btn btn-outline-warning" for="ocena-5">5</label>
                        <input type="radio" name="ocena" value="4" id="ocena-4" class="btn-check">
                        <label class="btn btn-outline-warning" for="ocena-4">4</label>
                        <input type="radio" name="ocena" value="3" id="ocena-3" class="btn-check">
                        <label class="btn btn-outline-warning" for="ocena-3">3</label>
                        <input type="radio" name="ocena" value="2" id="ocena-2" class="btn-check">
                        <label class="btn btn-outline-warning" for="ocena-2">2</label>
                        <input type="radio" name="ocena" value="1" id="ocena-1" class="btn-check">
                        <label class="btn btn-outline-warning" for="ocena-1">1</label>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-semibold">Komentarz (opcjonalny)</label>
                    <textarea id="opinia-komentarz" class="form-control" rows="3"
                        placeholder="Podziel się swoją opinią..."></textarea>
                </div>
                <button type="submit" class="btn btn-success" id="submit-opinia">Wyślij opinię</button>
                <small class="text-muted d-block mt-2">Możesz dodać opinię raz na 10 minut.</small>
            </form>

            <div id="opinia-message" class="mt-3"></div>

            <!-- Sekcja nieocenionych wizyt -->
            <h4 class="fw-semibold mt-5 mb-3">Oceń ostatnie wizyty</h4>
            <div id="search-container-nieocenione" class="d-none mb-3">
                <div class="input-group">
                    <input type="text" id="search-input-nieocenione" class="form-control"
                        placeholder="Szukaj w wizytach...">
                    <button id="btn-show-all-nieocenione" class="btn btn-outline-secondary">Pokaż wszystkie</button>
                </div>
            </div>
            <div id="nieocenione-lista"></div>
            <div id="pagination-container-nieocenione" class="d-none mt-3 text-center"></div>

            <!-- Lista opinii -->
            <h4 class="fw-semibold mt-5 mb-3">Twoje opinie</h4>
            <div id="search-container-opinie" class="d-none mb-3">
                <div class="input-group">
                    <input type="text" id="search-input-opinie" class="form-control" placeholder="Szukaj w opiniach...">
                    <button id="btn-show-all-opinie" class="btn btn-outline-secondary">Pokaż wszystkie</button>
                </div>
            </div>
            <div id="opinie-lista"></div>
            <div id="pagination-container-opinie" class="d-none mt-3 text-center"></div>

            <!-- Modal oceny wizyty -->
            <div class="modal fade" id="ocenaWizytyModal" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content border-0 shadow-lg">
                        <div class="modal-header border-0 pb-2">
                            <h5 class="modal-title fw-bold text-primary">
                                <i class="bi bi-star-fill me-2"></i>
                                Oceń wizytę
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                aria-label="Zamknij"></button>
                        </div>
                        <div class="modal-body pt-2">
                            <form id="form-ocena-wizyty">
                                <div class="mb-3 text-center">
                                    <div class="d-flex justify-content-center gap-2">
                                        <input type="radio" name="ocena-wizyty" value="5" id="ocena-wizyty-5"
                                            class="btn-check">
                                        <label class="btn btn-outline-warning p-2" for="ocena-wizyty-5"></label>
                                        <input type="radio" name="ocena-wizyty" value="4" id="ocena-wizyty-4"
                                            class="btn-check">
                                        <label class="btn btn-outline-warning p-2" for="ocena-wizyty-4"></label>
                                        <input type="radio" name="ocena-wizyty" value="3" id="ocena-wizyty-3"
                                            class="btn-check">
                                        <label class="btn btn-outline-warning p-2" for="ocena-wizyty-3"></label>
                                        <input type="radio" name="ocena-wizyty" value="2" id="ocena-wizyty-2"
                                            class="btn-check">
                                        <label class="btn btn-outline-warning p-2" for="ocena-wizyty-2"></label>
                                        <input type="radio" name="ocena-wizyty" value="1" id="ocena-wizyty-1"
                                            class="btn-check">
                                        <label class="btn btn-outline-warning p-2" for="ocena-wizyty-1"></label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Komentarz (opcjonalny)</label>
                                    <textarea id="ocena-wizyty-komentarz" class="form-control" rows="3"
                                        placeholder="Podziel się opinią o wizycie..."></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">Wyślij ocenę</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- KONTAKT -->
        <div id="section-contact" class="d-none animate-section">
            <h4 class="fw-semibold mb-4">Wyślij wiadomość</h4>
            <form id="form-contact" class="border rounded p-4 bg-light">
                <div class="mb-3">
                    <label class="form-label fw-semibold">Do kogo</label>
                    <select id="contact-recipient" class="form-select" required>
                        <option value="">Wybierz odbiorcę...</option>
                        <option value="admin">Administrator</option>
                        <option value="recepcja">Recepcja</option>
                        <option value="lekarz">Lekarz (wybierz poniżej)</option>
                    </select>
                </div>
                <div class="mb-3 d-none" id="doctor-select-container">
                    <label class="form-label fw-semibold">Lekarz</label>
                    <select id="contact-doctor" class="form-select">
                        <option value="">Wybierz lekarza...</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-semibold">Temat</label>
                    <input type="text" id="contact-subject" class="form-control" required />
                </div>
                <div class="mb-3">
                    <label class="form-label fw-semibold">Wiadomość</label>
                    <textarea id="contact-message" class="form-control" rows="5" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Wyślij wiadomość</button>
            </form>
            <div id="contact-result" class="mt-3"></div>
        </div>
        <!-- ROZMOWY -->
        <div id="section-chats" class="d-none animate-section">
            <h4 class="fw-semibold mb-4">Twoje rozmowy</h4>
            <div id="active-chat-header"
                class="d-none mb-3 p-3 bg-light rounded shadow-sm border-start border-primary border-4">
                <div class="d-flex align-items-center">
                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center fw-bold me-3"
                        style="width: 40px; height: 40px; font-size: 1.1rem;">
                        <span id="active-chat-initial">A</span>
                    </div>
                    <div>
                        <h6 class="mb-0 fw-bold text-primary" id="active-chat-title">Rozmowa</h6>
                        <small class="text-muted" id="active-chat-lastmsg">Ostatnia wiadomość: nigdy</small>
                    </div>
                </div>
            </div>
            <div id="search-container-chats" class="d-none mb-3">
                <div class="input-group">
                    <input type="text" id="search-input-chats" class="form-control" placeholder="Szukaj w rozmowach...">
                    <button id="btn-show-all-chats" class="btn btn-outline-secondary">Pokaż wszystkie</button>
                </div>
            </div>
            <div id="chat-list" class="list-group mb-3"></div>
            <div id="pagination-container-chats" class="d-none mt-3 text-center"></div>
            <div id="chat-view" class="border rounded p-3 bg-light d-none mt-4 shadow-sm">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 id="chat-title" class="mb-0 fw-bold text-primary"></h5>
                    <div>
                        <button id="btn-delete-chat" class="btn btn-sm btn-outline-danger me-2" title="Usuń rozmowę">
                            <i class="bi bi-trash"></i>
                        </button>
                        <button id="btn-back-to-list" class="btn btn-sm btn-outline-secondary">Wróć</button>
                    </div>
                </div>
                <div id="chat-messages" class="border rounded p-3 mb-3 bg-white"
                    style="height: 420px; overflow-y: auto; font-size: 1rem; line-height: 1.5;"></div>
                <form id="form-chat-message" class="input-group">
                    <input type="text" id="chat-input" class="form-control" placeholder="Napisz wiadomość..."
                        autocomplete="off" required />
                    <button type="submit" class="btn btn-primary">Wyślij</button>
                </form>
            </div>
            <!-- MODAL USUWANIA -->
            <div class="modal fade" id="deleteChatModal" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content border-0 shadow-lg">
                        <div class="modal-header border-0 pb-2">
                            <h5 class="modal-title fw-bold text-danger">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                Usunąć rozmowę?
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                aria-label="Zamknij"></button>
                        </div>
                        <div class="modal-body pt-2">
                            <p class="mb-2">Czy na pewno chcesz <strong>trwale usunąć</strong> rozmowę:</p>
                            <div class="bg-light rounded p-3 text-start border">
                                <div id="delete-chat-title-modal">—</div>
                            </div>
                            <p class="text-muted small mt-3 mb-0">
                                Tej operacji <strong>nie można cofnąć</strong>.
                            </p>
                        </div>
                        <div class="modal-footer border-0 pt-2">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                            <button type="button" class="btn btn-danger" id="confirm-delete-chat">
                                <i class="bi bi-trash me-1"></i> Usuń
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>